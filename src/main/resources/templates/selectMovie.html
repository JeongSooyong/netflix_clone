<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title th:text="${movie.movieTitle} + ' - 상세 정보'">영화 상세 정보</title>
    <link rel="stylesheet" href="/css/selectMovie.css">
    <link rel="stylesheet" href="/css/main.css">
    <script src="/js/selectMovie.js"></script>
</head>

<body>
    <header class="navbar">
        <div class="logo">NETFLIX</div>
        <nav>
            <a href="#">홈</a>
            <a href="#">시리즈</a>
            <a href="#">영화</a>
            <a href="#">내가 찜한 콘텐츠</a>
        </nav>
        <div class="profile">
            <a th:if="${loginUser != null and loginUser.commonNo == 104}" href="/insertMovie" class="admin-button">영화
                등록</a>
            <a href="/myinfo">내 정보</a>
            <a href="/logout">로그아웃</a>
        </div>
    </header>

    <div class="detail-container">
        <div class="detail-poster">
            <img th:src="@{/img/{filename}(filename=${movie.moviePoster})}" th:alt="${movie.movieTitle}">
        </div>
        <div class="detail-content">
            <h1 th:text="${movie.movieTitle}"></h1>
            <p th:text="${movie.movieDescrip}"></p>
            <div class="detail-info">
                <span th:if="${movie.movieReleaseDate}"
                    th:text="|개봉일: ${#temporals.format(movie.movieReleaseDate, 'yyyy-MM-dd')}|">개봉일: YYYY-MM-DD</span>
                <span th:text="|상영 시간: ${movie.movieDuration}분|">상영 시간: 00분</span>
                <span th:text="|장르: ${movie.genreName}">장르</span>
                <span th:text="|출연: ${actor}|">출연: 00</span>
                <span id="countLikeMovie" th:text="|추천수: ${countLikeMovie}">추천수: 0</span>
                <span th:text="|조회수: ${movie.movieViewCount}|">조회수: 0</span>
            </div>

            <a href="/main" class="btn-back">목록으로 돌아가기</a>
            <th:block th:if="${loginUser != null}">
                <button type="button" class="btn-like" id="toggleLikeButton" th:data-movie-no="${movie.movieNo}"
                    th:data-is-liked="${isLiked} ? 'true' : 'false'"
                    th:classappend="${isLiked} ? 'btn-unlike' : 'btn-like'">
                    <span th:text="${isLiked} ? '추천 취소' : '추천'"></span>
                </button>
            </th:block>
            <br>
            <a th:if="${loginUser != null and loginUser.commonNo == 104}"
                th:href="@{/updateMovie/{movieTitle}(movieTitle=${movie.movieTitle})}"
                class="btn-back btn-admin-action">영화 정보 수정</a>
            <br>
            <form th:if="${loginUser != null and loginUser.commonNo == 104 and movie.commonNo == 201}"
                th:action="@{/moviePrivate}" method="post" onsubmit="return confirm('정말로 이 영화를 비공개 처리하시겠습니까?');">
                <!-- 영화 제목을 hidden 파라미터로 전달 -->
                <input type="hidden" name="movieTitle" th:value="${movie.movieTitle}">

                <!-- 비공개 버튼 -->
                <button type="submit" class="btn-back btn-admin-action">
                    영화 비공개
                </button>
            </form>
        </div>
    </div>

    <div th:if="${movie.movieVideoUrl}" class="detail-video-embed">
        <!-- th:utext는 HTML 엔티티를 이스케이프하지 않고 그대로 렌더링합니다. -->
        <!-- movieVideoUrl이 iframe 태그 전체를 포함하고 있다고 가정 -->
        <div th:utext="${movie.movieVideoUrl}"></div>
    </div>
    <div class="review-section">
        <h2>리뷰</h2>

        <!-- 리뷰 작성 폼 (로그인한 사용자만 볼 수 있도록 조건부 렌더링) -->
        <div class="review-form" th:if="${loginUser != null}">
            <h3>리뷰 작성하기</h3>
            <form id="reviewForm">
                <input type="hidden" name="movieNo" th:value="${movie.movieNo}" id="movieNoInput">
                <input type="hidden" name="userNo" th:value="${loginUser.userNo}" id="userNoInput">

                <div class="rating">
                    <label>평점: </label>
                    <input type="radio" id="star5" name="reviewRating" value="5"><label for="star5">⭐</label>
                    <input type="radio" id="star4" name="reviewRating" value="4"><label for="star4">⭐</label>
                    <input type="radio" id="star3" name="reviewRating" value="3"><label for="star3">⭐</label>
                    <input type="radio" id="star2" name="reviewRating" value="2"><label for="star2">⭐</label>
                    <input type="radio" id="star1" name="reviewRating" value="1"><label for="star1">⭐</label>
                </div>
                <br>
                <textarea name="reviewComment" placeholder="이 영화에 대한 감상을 자유롭게 남겨주세요!" rows="5" required
                    id="reviewComment"></textarea>
                <button type="submit" class="btn-submit-review">리뷰 등록</button>
            </form>
        </div>

        <!-- 기존 리뷰 목록 표시 -->
        <div class="reviews-list" id="reviewsListContainer">
            <h3>관람객 리뷰</h3>
            <div class="review-item" th:each="reviewItem : ${review}">
                <p><strong>작성자: <span th:text="${reviewItem.userId}">리뷰 작성자명</span></strong></p>
                <p class="review-rating" th:text="${'⭐'.repeat(reviewItem.reviewRating)}">⭐⭐⭐⭐⭐</p>
                <p class="review-comment" th:text="${reviewItem.reviewComment}">이 영화 정말 재미있었어요! 스토리가 몰입감 있고 연기도 훌륭합니다.
                </p>
                <p class="review-date" th:text="${#temporals.format(reviewItem.reviewDate, 'yyyy.MM.dd HH:mm')}">
                    2025.08.15</p>
                <!-- 아래 버튼들은 필요에 따라 주석을 해제하고 사용하시면 됩니다. -->
                <!-- <button th:if="${loginUser != null and loginUser.userNo == reviewItem.userNo}" class="btn-edit-review">수정</button> -->
                <!-- <button th:if="${loginUser != null and (loginUser.userNo == reviewItem.userNo or loginUser.commonNo == 104)}" class="btn-delete-review">삭제</button> -->
            </div>
            <!-- 리뷰가 없을 경우를 위한 메시지 -->
            <div th:if="${review == null or review.isEmpty()}" class="no-reviews-message" id="noReviewsMessage">
                <p>아직 작성된 리뷰가 없습니다. 리뷰를 남겨주세요. </p>
            </div>
        </div>
    </div>

</body>

</html>