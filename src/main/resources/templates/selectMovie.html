<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title th:text="${movie.movieTitle} + ' - 상세 정보'">영화 상세 정보</title>
    <link rel="stylesheet" href="/css/selectMovie.css">
    <link rel="stylesheet" href="/css/main.css">
</head>
<script>
    // 페이지 로드 후 스크립트 실행
    document.addEventListener('DOMContentLoaded', function () {
        // 페이지에서 id가 toggleLikeButton인 요소를 찾아 toggleButton에 할당
        const toggleButton = document.getElementById('toggleLikeButton');

        // 좋아요 개수를 표시하는 span태그를 currentCountLikeMovie에 할당
        const currentCountLikeMovie = document.getElementById('countLikeMovie');

        // toggleButton의 존재 여부 확인
        if (toggleButton) {
            // toggleButton을 클릭했을때
            toggleButton.addEventListener('click', function () {

                // data-movieNo의 값을 movieNo에 할당
                const movieNo = this.dataset.movieNo;
                // data-isLiked의 타입, 값을 비교하여 isLiked에 할당
                let isLiked = this.dataset.isLiked === 'true';
                // isLiked가 true면 /likeMovieCancel을 false면 /likeMovie를 url에 할당
                // 영상에 추천이 눌러져있다면 버튼 클릭시 /likeMovieCancel을 요청해야함.
                const url = isLiked ? '/likeMovieCancel' : '/likeMovie';

                // buttonTextSpan에 toggleButton안의 span태그를 할당
                const buttonTextSpan = this.querySelector('span');

                this.disabled = true;

                // AJAX 요청
                fetch(url, {
                    // JSON형식으로 movieNo, Number(movieNo)를 문자열로 변환해서 서버에 데이터 전송
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ movieNo: Number(movieNo) })
                })
                    .then(response => {
                        // response.ok는 서버의 응답이 200~299인지 확인하는 코드
                        // 서버의 응답이 200~299가 아니라면 서버가 보낸 에러 JSON을 읽어 Error를 던짐
                        if (!response.ok) {
                            return response.json().then(errorData => {
                                throw new Error(errorData.message || '서버 오류 발생');
                            });
                        }
                        return response.json();
                    })
                    .then(data => {
                        // 처리에 성공했을때(추천이 성공적으로 완료됐을때)
                        if (data.success) {
                            // isLiked에 !isLiked를 할당
                            isLiked = !isLiked;
                            this.dataset.isLiked = isLiked ? 'true' : 'false'; // data 속성 업데이트

                            buttonTextSpan.textContent = isLiked ? '추천 취소' : '추천'; // 버튼 텍스트 변경
                            this.classList.toggle('btn-unlike', isLiked);
                            this.classList.toggle('btn-like', !isLiked);

                            // data객체가 currentCountLikeMovie를 고유 속성으로 가지고 있는지 확인
                            if (data.hasOwnProperty('currentLikeCount')) {
                                // span태그 안에서 currentCountLikeMovie 변수 할당 성공여부 확인
                                if (currentCountLikeMovie) {
                                    currentCountLikeMovie.textContent = data.currentLikeCount;
                                }
                            }
                            else {
                                // span 태그가 존재하는지 확인
                                if (currentCountLikeMovie) {
                                    // 현재 화면에 표시된 개수를 파싱 (문자열 -> 숫자)
                                    let currentCount = parseInt(currentCountLikeMovie.textContent);
                                    // 이제 '좋아요' 상태라면 1증가
                                    if (isLiked) {
                                        currentCount++;
                                    } else { // 이제 '좋아요 취소' 상태라면 1 감소
                                        currentCount--;
                                    }
                                    currentCountLikeMovie.textContent = currentCount;
                                }
                            }

                            // 사용자에게 성공 메시지 표시
                            alert(data.message);
                        } else {
                            alert('작업 실패: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('AJAX 오류:', error);
                        alert('오류가 발생했습니다: ' + error.message);
                    })
                    .finally(() => {
                        this.disabled = false;
                    })
            });
        }
    });
</script>

<body>
    <header class="navbar">
        <div class="logo">NETFLIX</div>
        <nav>
            <a href="#">홈</a>
            <a href="#">시리즈</a>
            <a href="#">영화</a>
            <a href="#">내가 찜한 콘텐츠</a>
        </nav>
        <div class="profile">
            <a th:if="${loginUser != null and loginUser.commonNo == 104}" href="/insertMovie" class="admin-button">영화
                등록</a>
            <a href="/myinfo">내 정보</a>
            <a href="/logout">로그아웃</a>
        </div>
    </header>

    <div class="detail-container">
        <div class="detail-poster">
            <img th:src="@{/img/{filename}(filename=${movie.moviePoster})}" th:alt="${movie.movieTitle}">
        </div>
        <div class="detail-content">
            <h1 th:text="${movie.movieTitle}"></h1>
            <p th:text="${movie.movieDescrip}"></p>
            <div class="detail-info">
                <span th:if="${movie.movieReleaseDate}"
                    th:text="|개봉일: ${#temporals.format(movie.movieReleaseDate, 'yyyy-MM-dd')}|">개봉일: YYYY-MM-DD</span>
                <span th:text="|상영 시간: ${movie.movieDuration}분|">상영 시간: 00분</span>
                <span th:text="|장르: ${movie.genreName}">장르</span>
                <span id="countLikeMovie" th:text="${countLikeMovie}">0</span>
                <span th:text="|조회수: ${movie.movieViewCount}|">조회수: 0</span>
            </div>

            <a href="/main" class="btn-back">목록으로 돌아가기</a>
            <th:block th:if="${loginUser != null}">
                <button type="button" class="btn-like" id="toggleLikeButton" th:data-movie-no="${movie.movieNo}"
                    th:data-is-liked="${isLiked} ? 'true' : 'false'"
                    th:classappend="${isLiked} ? 'btn-unlike' : 'btn-like'">
                    <span th:text="${isLiked} ? '추천 취소' : '추천'"></span>
                </button>
            </th:block>
            <br>
            <a th:if="${loginUser != null and loginUser.commonNo == 104}"
                th:href="@{/updateMovie/{movieTitle}(movieTitle=${movie.movieTitle})}"
                class="btn-back btn-admin-action">영화 정보 수정</a>
            <br>
            <form th:if="${loginUser != null and loginUser.commonNo == 104 and movie.commonNo == 201}"
                th:action="@{/moviePrivate}" method="post" onsubmit="return confirm('정말로 이 영화를 비공개 처리하시겠습니까?');">
                <!-- 영화 제목을 hidden 파라미터로 전달 -->
                <input type="hidden" name="movieTitle" th:value="${movie.movieTitle}">

                <!-- 비공개 버튼 -->
                <button type="submit" class="btn-back btn-admin-action">
                    영화 비공개
                </button>
            </form>
        </div>
    </div>

    <div th:if="${movie.movieVideoUrl}" class="detail-video-embed">
        <!-- th:utext는 HTML 엔티티를 이스케이프하지 않고 그대로 렌더링합니다. -->
        <!-- movieVideoUrl이 iframe 태그 전체를 포함하고 있다고 가정 -->
        <div th:utext="${movie.movieVideoUrl}"></div>
    </div>

</body>

</html>