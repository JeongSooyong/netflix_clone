<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title th:text="${movie.movieTitle} + ' - 상세 정보'">영화 상세 정보</title>
    <link rel="stylesheet" href="/css/selectMovie.css">
    <link rel="stylesheet" href="/css/main.css">
</head>
<script>
    // 페이지 로드 후 스크립트 실행
    document.addEventListener('DOMContentLoaded', function() {
        const toggleButton = document.getElementById('toggleLikeButton');

        if (toggleButton) { // 버튼이 존재하는 경우에만 이벤트 리스너 추가
            toggleButton.addEventListener('click', function() {
                const movieNo = this.dataset.movieNo;
                let isLiked = this.dataset.isLiked === 'true'; // 현재 좋아요 상태 (Boolean으로 변환)

                const url = '/likeMovie'; // 컨트롤러의 @PostMapping("/likeMovie") 경로

                const buttonTextSpan = this.querySelector('span');

                // AJAX 요청 (fetch API 사용)
                fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ movieNo: movieNo })
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(errorData => {
                            throw new Error(errorData.message || '서버 오류 발생');
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        // 성공적으로 처리되었을 때 (서버가 토글했든, 새로 좋아요를 눌렀든)
                        // 클라이언트의 좋아요 상태를 업데이트하고 UI를 변경합니다.
                        isLiked = !isLiked; // 현재 상태 반전 (토글)
                        this.dataset.isLiked = isLiked ? 'true' : 'false'; // data 속성 업데이트

                        buttonTextSpan.textContent = isLiked ? '추천 취소' : '추천'; // 버튼 텍스트 변경
                        this.classList.toggle('btn-unlike', isLiked); // '추천 취소' 스타일
                        this.classList.toggle('btn-like', !isLiked);  // '추천' 스타일

                        // 사용자에게 성공 메시지 표시
                        alert(data.message);
                    } else {
                        // 서버에서 'success: false'를 보냈을 경우 (예: 이미 추천함)
                        alert('작업 실패: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('AJAX 오류:', error);
                    alert('오류가 발생했습니다: ' + error.message);
                });
            });
        }
    });
</script>

<body>
    <header class="navbar">
        <div class="logo">NETFLIX</div>
        <nav>
            <a href="#">홈</a>
            <a href="#">시리즈</a>
            <a href="#">영화</a>
            <a href="#">내가 찜한 콘텐츠</a>
        </nav>
        <div class="profile">
            <a th:if="${loginUser != null and loginUser.commonNo == 104}" href="/insertMovie" class="admin-button">영화
                등록</a>
            <a href="/myinfo">내 정보</a>
            <a href="/logout">로그아웃</a>
        </div>
    </header>

    <div class="detail-container">
        <div class="detail-poster">
            <img th:src="@{/img/{filename}(filename=${movie.moviePoster})}" th:alt="${movie.movieTitle}">
        </div>
        <div class="detail-content">
            <h1 th:text="${movie.movieTitle}"></h1>
            <p th:text="${movie.movieDescrip}"></p>
            <div class="detail-info">
                <span th:if="${movie.movieReleaseDate}"
                    th:text="|개봉일: ${#temporals.format(movie.movieReleaseDate, 'yyyy-MM-dd')}|">개봉일: YYYY-MM-DD</span>
                <span th:text="|상영 시간: ${movie.movieDuration}분|">상영 시간: 00분</span>
                <span th:text="|장르: ${movie.genreName}">장르</span>
                <span th:text="|조회수: ${movie.movieViewCount}|">조회수: 0</span>
            </div>

            <a href="/main" class="btn-back">목록으로 돌아가기</a>
            <th:block th:if="${loginUser != null}">
                <button type="button" class="btn-like" id="toggleLikeButton" th:data-movie-no="${movie.movieNo}"
                    th:data-is-liked="${isLiked} ? 'true' : 'false'"
                    th:classappend="${isLiked} ? 'btn-unlike' : 'btn-like'">
                    <span th:text="${isLiked} ? '추천 취소' : '추천'"></span>
                </button>
            </th:block>
            <br>
            <a th:if="${loginUser != null and loginUser.commonNo == 104}"
                th:href="@{/updateMovie/{movieTitle}(movieTitle=${movie.movieTitle})}"
                class="btn-back btn-admin-action">영화 정보 수정</a>
            <br>
            <form th:if="${loginUser != null and loginUser.commonNo == 104 and movie.commonNo == 201}"
                th:action="@{/moviePrivate}" method="post" onsubmit="return confirm('정말로 이 영화를 비공개 처리하시겠습니까?');">
                <!-- 영화 제목을 hidden 파라미터로 전달 -->
                <input type="hidden" name="movieTitle" th:value="${movie.movieTitle}">

                <!-- 비공개 버튼 -->
                <button type="submit" class="btn-back btn-admin-action">
                    영화 비공개
                </button>
            </form>
        </div>
    </div>

    <div th:if="${movie.movieVideoUrl}" class="detail-video-embed">
        <!-- th:utext는 HTML 엔티티를 이스케이프하지 않고 그대로 렌더링합니다. -->
        <!-- movieVideoUrl이 iframe 태그 전체를 포함하고 있다고 가정 -->
        <div th:utext="${movie.movieVideoUrl}"></div>
    </div>

</body>

</html>